<!DOCTYPE html>
<html>

<head>
    <title>Anticipatory Gaze EC</title>
    <script src="https://unpkg.com/jspsych@8.0.0"></script>  
    
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@2.0.0"></script>

    <script src="https://cdn.jsdelivr.net/gh/jspsych/jspsych@jspsych@7.0.0/examples/js/webgazer/webgazer.js"></script>
    <script src="https://unpkg.com/@jspsych/extension-webgazer@1.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-webgazer-calibrate@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-webgazer-init-camera@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-webgazer-validate@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>


    <link href="https://unpkg.com/jspsych@8.0.0/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="style.css">
</head>

<body></body>
<script>
    const jsPsych = initJsPsych({
        extensions: [
            {type: jsPsychExtensionWebgazer}
        ]
    });

    var wordlist = [[],[]];
    var used_words = [[],[]];

    const trials = 10;

    var count = trials;
    var word = "";

    var treatment = jsPsych.randomization.shuffle(["free_sampling", "regular_ec"])[0];

    fetch("wordlist_negative.txt")
        .then((r) => r.text())
        .then((text) => {
            wordlist[0] = jsPsych.randomization.shuffle(text.match(/\S+/g));
            console.log(wordlist[0].length)
        })
        

    fetch("wordlist_positive.txt")
        .then((r) => r.text())
        .then((text) => {
            wordlist[1] = jsPsych.randomization.shuffle(text.match(/\S+/g));
            console.log(wordlist[1].length)
        })

    const associations = jsPsych.randomization.shuffle([0, 0, 0, 1, 1, 1]);

    // Define the image stimuli and associations
    const images = jsPsych.randomization.shuffle([
        { image: 'img/image1.png', association: associations[0] },
        { image: 'img/image2.png', association: associations[1] },
        { image: 'img/image3.png', association: associations[2] },
        { image: 'img/image4.png', association: associations[3] },
        { image: 'img/image5.png', association: associations[4] },
        { image: 'img/image6.png', association: associations[5] },
    ]);

    // Randomize the positions for each subject
    const positions = jsPsych.randomization.shuffle([
        { left: '50%', top: '20%' },
        { left: '80%', top: '35%' },
        { left: '80%', top: '65%' },
        { left: '50%', top: '80%' },
        { left: '20%', top: '65%' },
        { left: '20%', top: '35%' }
    ]);

    // Randomize the positions for each subject
    const left_right = jsPsych.randomization.shuffle(['25%','75%']);

    jsPsych.data.addProperties({
        image1: images[0].image,
        image2: images[1].image,
        image3: images[2].image,
        image4: images[3].image,
        image5: images[4].image,
        image6: images[5].image,
        image1_association: images[0].association,
        image2_association: images[1].association,
        image3_association: images[2].association,
        image4_association: images[3].association,
        image5_association: images[4].association,
        image6_association: images[5].association,
        position1_left: positions[0].left,
        position1_top: positions[0].top,
        position2_left: positions[1].left,
        position2_top: positions[1].top,
        position3_left: positions[2].left,
        position3_top: positions[2].top,
        position4_left: positions[3].left,
        position4_top: positions[3].top,
        position5_left: positions[4].left,
        position5_top: positions[4].top,
        position6_left: positions[5].left,
        position6_top: positions[5].top,
        negative_position: left_right[0],
        positive_position: left_right[1],
        treatment: treatment
    });

    const welcome = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <div style="font-size:40px">Willkommen zur Studie!</div>
            <p>
                Diese Studie besteht aus verschiedenen Aufgaben, bei denen Sie Formen betrachten und Wörter lesen, Urteile fällen und einige Fragen zu Ihrer Person beantworten. Dabei interessiert uns neben Ihren Einschätzungen auch das Blickverhalten, während die Aufgaben bearbeitet werden. Bitte beachten Sie, dass eine der Aufgaben das Lesen negativer Wörter beinhaltet, von denen einige sehr unangenehme Bedeutungen haben können. Sie sollten daher nur an dieser Studie teilnehmen, wenn das für Sie in Ordnung ist. 
                <br><br>
                Infos zur Einverständniserklärung <br>
                Datenschutz<br>
                Freiwilligkeit, etc.<br>
            </p>
        `,
        choices: ['Weiter'],
    }

    const evaluation1_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Im Folgenden bitten wir Sie, farbige Quadrate zu beurteilen. 
                
                <br><br>

                Sie werden nun 6 Quadrate in verschiedenen Farben sehen. Geben Sie bitte an, wie positiv oder negativ Ihre emotionalen Reaktionen auf die farbigen Quadrate sind. 

                <br><br>

                Dabei gibt es keine richtigen oder falschen Antworten. Es kommt uns nur auf Ihre persönliche Einschätzung an. 

            </p>
        `,
        choices: ['Weiter'],
    }

    const evaluation1 = {
        type: jsPsychHtmlSliderResponse,
        timeline: [
            {
                stimulus: function () {
                    const html = `
                        <p>
                            Wie positiv oder negativ ist Ihr Eindruck des Quadrats in dieser Farbe?
                        </p>
                        <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;">
                    `
                    return html;
                }
            }
        ],
        timeline_variables: [
            { image: images[0].image },
            { image: images[1].image },
            { image: images[2].image },
            { image: images[3].image },
            { image: images[4].image },
            { image: images[5].image },
        ],
        button_label: 'Weiter',
        require_movement: true,
        labels: ['sehr negativ', 'neutral', 'sehr positiv'],
    }

    /** full screen **/
    var fullscreenEnter = {
        type: jsPsychFullscreen,
        message: `
            <div> The study will switch to full screen mode when you press the button below.  <br/>
            Your webcam will be turned on during the study.<br/>
            If you do not wish to allow the use of your camera,  close the study page now. <br/>
            <br><br/>
            Once the study has started, <b>DO NOT EXIT</b> full screen mode. <br/> 
            <br><br/>
            When you are ready to begin, press the button.</div>
        `,
        fullscreen_mode: true,
        on_finish: function () {
            document.body.style.cursor = 'none'
        }
    };

    var fullscreenEnd = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    };

    /*****************************
    ***********Eye tracking ***********
    *****************************/

    var cali_points = [[20,20],[20,80],[80,20], [50,50],[20,50],[50,20],[80,80],[80,50],[50,80]];
    var point_size = 50;
    var threshold = 0.7;
    var recalibrate_criterion = 0.2;
    var calibration_mode = 'view';

    var eyeTrackingInstruction1 = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <div> <font size=120%; font color = 'green';>Webcam Calibration & Validation </font><br/>
            <br><br/>
            Before we begin with the study, we need to turn on and adjust your webcam for eye-tracking.   
            <br/>
            There are two parts to this process. The first part is calibration and the second part is validation.<br/>
            <br><br/>
            During calibration, you will see a series of dots like this <span id="calibration_dot_instruction"></span> appear on the screen, each for 2 seconds. <br/>
            Your task is simply to stare directly at each dot until it disappears.<br/>
            Then, quickly move your eyes to the next dot and repeat.<br/>
            <br><br/>
            Validation is basically the same as calibration. You simply need to stare at each dot until it disappears.<br/>
            <br><br/>
            When you are ready, press the <b>SPACE BAR</b> to continue. </div>
        `,
        post_trial_gap: 500,
        choices: [' '],

    }

    var eyeTrackingInstruction2 = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            We now need to calibrate again.
            <br><br/>
            When you are ready, press the <b>SPACE BAR</b> to continue. </div>
        `,
        post_trial_gap: 500,
        choices: [' '],

    }

    var eyeTrackingNote = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <div><font size=120%; font color = 'green';>Webcam Calibration & Validation</font><br/>
            <br><br>
            <font size = 5px font color = "darkred">There are several <b>IMPORTANT</b> tips that are useful for passing the calibration task:<br/></font>
            <img height="200px" width="1000px" src="img/instruct1.png"><br/>
            <br><br>
            <div style="text-align-last:left">
                In addition to the tips in the figure: <br>
                (1). Use your eyes to look around the screen and try to avoid moving your head. <br/>
                (2). Try to keep lights in front of you rather than behind you so that the webcam can clearly see your face. Avoid sitting with a window behind you. <br/>
                (3). After you have made these adjustments, check again that your face fits nicely within the box on the video feed and that the box is green. <br/>
            </div>
            <br><br/>
            <br><br/>
            <font size=5px; >When you are ready, press the <b>SPACE BAR</b> to continue </font></div>
        `,
        post_trial_gap: 500,
        choices: [' '],
    }


    var calibrationInstruction= {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <div>
                It may take up to 30 seconds for the camera to initialize. <br/>
                <br><br/>
                When you are ready, press the <b>SPACE BAR</b> to bring up the video feed.  
            </div>
        `,
        post_trial_gap: 500,
        choices: [' '],
        on_finish: () => document.body.style.cursor = 'pointer',
    }



    var init_camera = {
        type: jsPsychWebgazerInitCamera,
        on_finish: function() {
            if (calibration_mode == 'view') {
                document.body.style.cursor = 'none';
            }
        }
    };


    var calibration = {
        type: jsPsychWebgazerCalibrate,
        calibration_points: cali_points,
        calibration_mode: calibration_mode,
        point_size: point_size,
        time_per_point: 2000,
        repetitions_per_point: 1,
        randomize_calibration_order: true,
        test_mode:true,
    }

    var validationInstruction = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus:`
            <div>  Now we'll measure the accuracy of the calibration. <br/>
            <br><br/>
            When you are ready, press the <b>SPACE BAR</b> to begin the validation. </div>
        `,
        choices: [' '],
        post_trial_gap: 1000,
        on_finish: () =>  document.body.style.cursor = 'none',
    }
    

    var validation = {
        type: jsPsychWebgazerValidate,
        validation_points: cali_points, 
        roi_radius: 200,
        time_to_saccade: 1000,
        validation_duration: 2000,
        point_size: point_size,
        show_validation_data: false,
        dot_threshold: threshold,
        data: {
            task: 'validate'
        },
        on_finish: () => document.body.style.cursor = 'pointer',
    }


    var recalibrateInstruction = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <p>The accuracy of the calibration is a little lower than we'd like.</p>
            <p>Let's try calibrating one more time.</p>
            <br></br>
            <p>When you are ready, press the <b>SPACE BAR</b> to recalibrate.  </p>
        `,
        choices: [' '],
    }


    var recalibrate = {
        timeline: [recalibrateInstruction, calibration, validationInstruction, validation],
        conditional_function: function(){
            var validation_data = jsPsych.data.get().filter({task: 'validate'}).values()[0];
            var below_threshold_count = validation_data.percent_in_roi.filter(function(x) {
                var minimum_percent_acceptable = threshold;
                return x < minimum_percent_acceptable}).length;
        
                return below_threshold_count/cali_points.length >= recalibrate_criterion;

            // return validation_data.percent_in_roi.some(function(x){
            //   var minimum_percent_acceptable = threshold;
            //   return x < minimum_percent_acceptable;
            // });
        },
        data: {
            phase: 'recalibration'
        }
    }

    /*****************************
    *********** Experiment ***********
    *****************************/

    const free_sampling_transition = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Im Folgenden erfahren Sie mehr darüber, welche positiven oder negativen Eigenschaften mit den farbigen Quadraten verbunden sind. 
                <br><br>
                Pro Durchgang sehen Sie alle 6 Quadrate in einer Übersicht. Sie wählen durch Anklicken jeweils eines der farbigen Quadrate aus. Das ausgewählte Quadrat wird dann gleichzeitig mit einem <b>positiven</b> oder <b>negativen</b> Eigenschaftswort gezeigt.  
                <br><br>
                Danach kehren Sie zur Übersicht aller 6 Quadrate zurück. <b>Klicken Sie auf das Bild eines Quadrats</b>, um mehr über seine Eigenschaften zu erfahren. Insgesamt haben Sie die Möglichkeit, in <b>${trials} Durchgängen</b> etwas über die Eigenschaften der Quadrate zu erfahren.
                <br><br>
                <b>Sie können jedes Mal völlig frei entscheiden, bei welchem farbigen Quadrat Sie mehr über dessen Eigenschaften erfahren möchten.</b>
            </p>
        `,
        choices: ['Weiter'],
    }

    const free_sampling_introduction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Jetzt geht es mit der eigentlichen Aufgabe los. Hier eine kurze Erinnerung:
                <br><br>
                Pro Durchgang sehen Sie alle 6 Quadrate in einer Übersicht. Sie wählen durch Anklicken jeweils eines der farbigen Quadrate aus. Das ausgewählte Quadrat wird dann gleichzeitig mit einem <b>positiven</b> oder <b>negativen</b> Eigenschaftswort gezeigt.  
                <br><br>
                Danach kehren Sie zur Übersicht aller 6 Quadrate zurück. <b>Klicken Sie auf das Bild eines Quadrats</b>, um mehr über seine Eigenschaften zu erfahren. Insgesamt haben Sie die Möglichkeit, in <b>${trials} Durchgängen</b> etwas über die Eigenschaften der Quadrate zu erfahren.
                <br><br>
                <b>Sie können jedes Mal völlig frei entscheiden, bei welchem farbigen Quadrat Sie mehr über dessen Eigenschaften erfahren möchten.</b>
            </p>
        `,
        choices: ['Weiter'],
    }

    const free_sampling = {
        timeline: [
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function () {
                    const html = `
                        Klicken Sie auf ein Quadrat, um einen Durchgang zu beginnen!
                        <br><br>
                        Verbleibende Durchgänge ${count}
                    `
                    return html;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `+`,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '',
                choices: "NO_KEYS",
                on_start: function (trial) {
                    let html = ``;
                    for (let i = 0; i < images.length; i++) {
                        const style = `position: absolute; left: ${positions[i].left}; top: ${positions[i].top}; transform: translateX(-50%) translateY(-50%); width: 100px; height: 100px; cursor: pointer;`;
                        html += `<img src="${images[i].image}" style="${style}" id="img-${i}" data-image="${images[i].image}" onclick="handleImageClick(event, ${i})" />`;
                    }
                    trial.stimulus = html;
                },
                on_finish: function (data) {
                    data.clicked_image = window.clicked_image;
                    data.association = window.association;
                    data.count = count;
                },
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#img-0','#img-1','#img-2','#img-3','#img-4','#img-5']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                on_start: function (trial) {
                    const style_image = `position: absolute; left: ${left_right[jsPsych.data.get().last(2).values()[0].association]}; top: 50%; transform: translateX(-50%) translateY(-40%); width: 100px; height: 100px;`;
                    let html = `<img style="${style_image}" id="square" src="${jsPsych.data.get().last(2).values()[0].clicked_image}" />`;
                    
                    word = wordlist[jsPsych.data.get().last(2).values()[0].association].pop();
                    const style_word = `position: absolute; left: ${left_right[jsPsych.data.get().last(2).values()[0].association]}; top: 50%; transform: translateX(-50%) translateY(+50px); width: 100px; height: 100px;`;
                    html += `<p style="${style_word}">${word}</p>`
                    used_words[jsPsych.data.get().last(2).values()[0].association].push(word);

                    console.log(used_words)

                    count --;
                    if (count == 0)
                        count = trials;
                    trial.stimulus = html;
                },
                on_finish: function (data) {
                    data.word = word;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#square']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
        ]
    }

    // Function to handle image click
    function handleImageClick(event, id) {
        window.clicked_image = images[id].image;
        window.association = images[id].association;
        console.log(`Count: ${count}, Clicked image: ${window.clicked_image}, Association: ${window.association}`);
        jsPsych.finishTrial();
    }

    // Define the free_sampling procedure
    const free_samplings = {
        timeline: []
    };

    for (let i=0; i<trials; i++) {
        if (i == trials/2) {
            free_samplings.timeline.push(eyeTrackingInstruction2,calibration)
        }
        free_samplings.timeline.push(free_sampling);
    }

    const regular_ec_transition = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Im Folgenden erfahren Sie mehr darüber, welche positiven oder negativen Eigenschaften mit den farbigen Quadraten verbunden sind. 
                <br><br>
                Pro Durchgang sehen Sie alle 6 Quadrate in einer Übersicht. Der Computer wird wiederholt und nach dem Zufallsprinzip entscheiden, zu welchem Quadrat Sie mehr erfahren. Das ausgewählte Quadrat wird dann gleichzeitig mit einem <b>positiven</b> oder <b>negativen</b> Eigenschaftswort gezeigt.
                <br><br> 
                Nach jedem Durchgang kehren Sie zur Übersicht aller 6 Quadrate zurück. Insgesamt werden <b>${trials} zufällige Durchgänge</b> gezeigt, in denen Sie etwas über die Eigenschaften der Quadrate erfahren.
                <b>Bitte beobachten Sie diese Durchgänge aufmerksam.</b>
            </p>
        `,
        choices: ['Weiter'],
    }

    const regular_ec_introduction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Jetzt geht es mit der eigentlichen Aufgabe los. Hier eine kurze Erinnerung: 
                <br><br>
                Pro Durchgang sehen Sie alle 6 Quadrate in einer Übersicht. Der Computer wird wiederholt und nach dem Zufallsprinzip entscheiden, zu welchem Quadrat Sie mehr erfahren. Das ausgewählte Quadrat wird dann gleichzeitig mit einem <b>positiven</b> oder <b>negativen</b> Eigenschaftswort gezeigt.
                <br><br> 
                Nach jedem Durchgang kehren Sie zur Übersicht aller 6 Quadrate zurück. Insgesamt werden <b>${trials} zufällige Durchgänge</b> gezeigt, in denen Sie etwas über die Eigenschaften der Quadrate erfahren.
                <b>Bitte beobachten Sie diese Durchgänge aufmerksam.</b>
            </p>
        `,
        choices: ['Weiter'],
    }

    const regular_ec = {
        timeline: [
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function () {
                    const html = `
                        Der Computer entscheidet nach dem Zufallsprinzip über den nächsten Durchgang!
                        <br><br>
                        Verbleibende Durchgänge ${count}
                    `
                    return html;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `+`,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '',
                choices: "NO_KEYS",
                trial_duration: 2000,
                on_start: function (trial) {
                    let html = ``;
                    for (let i = 0; i < images.length; i++) {
                        const style = `position: absolute; left: ${positions[i].left}; top: ${positions[i].top}; transform: translateX(-50%) translateY(-50%); width: 100px; height: 100px;`;
                        html += `<img src="${images[i].image}" style="${style}" id="img-${i}" data-image="${images[i].image}"/>`;
                    }
                    trial.stimulus = html;
                },
                on_finish: function (data) {
                    rand_id = Math.floor(Math.random() * 6);
                    data.clicked_image = images[rand_id].image;
                    data.association = images[rand_id].association;
                    data.count = count;
                },
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#img-0','#img-1','#img-2','#img-3','#img-4','#img-5']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                on_start: function (trial) {
                    const style_image = `position: absolute; left: ${left_right[jsPsych.data.get().last(2).values()[0].association]}; top: 50%; transform: translateX(-50%) translateY(-40%); width: 100px; height: 100px;`;
                    let html = `<img style="${style_image}" id="square" src="${jsPsych.data.get().last(2).values()[0].clicked_image}" />`;
                    
                    word = wordlist[jsPsych.data.get().last(2).values()[0].association].pop();
                    const style_word = `position: absolute; left: ${left_right[jsPsych.data.get().last(2).values()[0].association]}; top: 50%; transform: translateX(-50%) translateY(+50px); width: 100px; height: 100px;`;
                    html += `<p style="${style_word}">${word}</p>`
                    used_words[jsPsych.data.get().last(2).values()[0].association].push(word);

                    console.log(used_words)

                    count --;
                    if (count == 0)
                        count = trials;
                    trial.stimulus = html;
                },
                on_finish: function (data) {
                    data.word = word;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#square']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
        ]
    }

    // Define the regular_ec procedure
    const regular_ecs = {
        timeline: []
    };

    for (let i=0; i<trials; i++) {
        if (i == trials/2) {
            regular_ecs.timeline.push(eyeTrackingInstruction2,calibration)
        }
        regular_ecs.timeline.push(regular_ec);
    }

    const evaluation2_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Bitte beurteilen Sie die farbigen Quadrate noch einmal. 
                <br><br>
                Sie werden nun alle 6 Quadrate einzeln sehen. Geben Sie bitte an, wie <b>positiv oder negativ</b> Ihre emotionalen Reaktionen auf das jeweilige Quadrat ist. 
                Dabei gibt es wie zuvor keine richtigen oder falschen Antworten. Es kommt uns nur auf Ihre persönliche Einschätzung an. 
                <br><br>
                Dieses Mal geben Sie bitte außerdem an, wie <b>sicher</b> Sie sich bei Ihren einzelnen Einschätzungen sind. Geben Sie an, wie lange Sie bei der Entscheidung nachdenken mussten bzw. wie viel Zeit Sie dafür gebraucht haben.
            </p>
        `,
        choices: ['Weiter'],
    }

    const evaluation2 = {
        timeline: [
            {
                type: jsPsychHtmlSliderResponse,
                stimulus: function () {
                    const html = `
                        <p>
                            Wie positiv oder negativ ist Ihr Eindruck des Quadrats in dieser Farbe?
                        </p>
                        <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;">
                    `
                    return html;
                },
                require_movement: true,
                labels: ['sehr negativ', 'neutral', 'sehr positiv'],
            },
            {
                type: jsPsychSurveyLikert,
                preamble: function () {
                    const html = `
                        <p>
                            Wie sicher sind Sie sich bei Ihrer Einschätzung dieses Quadrats?
                        <p>
                        <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;">
                    `
                    return html;
                },
                questions: [
                    {
                        prompt: "",
                        labels: [
                            "0<br>gar nicht sicher",
                            "1",
                            "2",
                            "3",
                            "4",
                            "5",
                            "6",
                            "7",
                            "8",
                            "9",
                            "10<br>extrem sicher",
                        ],
                        required: true,
                    }
                ]
            },
        ],
        timeline_variables: [
            { image: images[0].image },
            { image: images[1].image },
            { image: images[2].image },
            { image: images[3].image },
            { image: images[4].image },
            { image: images[5].image },
        ],
        button_label: 'Weiter',
    }

    const estimate = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: `
            <p>
                Während der Durchgänge sind die Quadrate gleichzeitig mit positiven oder negativen Eigenschaftsworte gezeigt worden. <br><br>Ihrer Schätzung nach, wie viele der ${trials} Eigenschaftsworte waren positiv bzw. negativ?
                <br><br>
                Anzahl der positiven Eigenschaftsworte: <input id="estimate_positive" name="estimate_positive" type="number" min="0" max="${trials}" style="width:100px;" oninput="checkEstimates()" required /><br>
                Anzahl der negativen Eigenschaftsworte: <input id="estimate_negative" name="estimate_negative" type="number" min="0" max="${trials}" style="width:100px;" oninput="checkEstimates()" required />
                <br><br>
                ACHTUNG! Die Summer beider Zahlen muss ${trials} ergeben!
            </p>
            <button id="next" class="jspsych-btn" onclick="jsPsych.finishTrial()" disabled>Weiter</button>
        `,
    };

    const estimate_individuals = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: function () {
            let html = 'Schätzen Sie: Wie oft haben Sie die jeweiligen Quadrate gesehen?<br><br>';
            for (let i=0; i<images.length; i++) {
                html += `
                    <img src="${images[i].image}" style="width:50px; transform: translateY(+25%); margin-right: 50px;" />
                    <input name="estimate_${i}" type="number" min="0" max="${trials}" style="width:100px;" oninput="checkEstimates()" required /> Durchgänge (0 bis ${trials})<br>
                `
            }
            html += `
                <p>ACHTUNG! Die Summer aller Zahlen muss ${trials} ergeben!</p>
                <button id="next" class="jspsych-btn" onclick="jsPsych.finishTrial()" disabled>Weiter</button>
            `
            return html;
        },
        on_finish: function(data) {
            data.estimate_individuals = window.estimate_individuals;
        }
    };

    // Function to handle button click
    function checkEstimates() {
        estimates = document.querySelectorAll("input[type=number]");
        
        var est = 0;

        let estimate_individuals = "";

        for (let i=0; i<estimates.length; i++) {
            est += parseInt(estimates[i].value);
            if (parseInt(estimates[i].value) > 0)
                estimate_individuals += 1;
            else
                estimate_individuals += 0;
        }

        window.estimate_individuals = estimate_individuals;

        console.log(estimate_individuals);

        if(est==trials) {
            document.getElementById("next").disabled = false;
        } else {
            document.getElementById("next").disabled = true;
        }
    }

    const joint_occurence_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Nachfolgend sehen Sie alle Quadrate, für die Sie mindestens einen Durchgang angegeben haben. 
                <br><br>
                Geben Sie für jedes Quadrat an, ob es Ihrer Meinung nach öfter zusammen mit positiven oder negativen Eigenschaftsworten auftrat.
            </p>
        `,
        choices: ['Weiter'],
    }

    var joint_occurence = {
        type: jsPsychSurveyMultiChoice,
        timeline: [
            {
                preamble: function () {
                    let html = `
                        <p style="text-align: center;">
                            <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;"><br>
                            Trat dieses Quadrat öfter gemeinsam mit positiven oder mit negativen Eigenschaftsworten auf?
                        </p>
                    `
                    return html;
                }, 
                questions: [
                    {
                        prompt: "", 
                        options: [
                            'Mit <b>positiven</b> Eigenschaftsworten', 
                            'Mit <b>negativen</b> Eigenschaftsworten'
                        ], 
                        required: true
                    }
                ],
            },
        ],
        timeline_variables: [
            { image: images[0].image },
            { image: images[1].image },
            { image: images[2].image },
            { image: images[3].image },
            { image: images[4].image },
            { image: images[5].image },
        ],
        button_label: 'Weiter',
        sample: {
            type: 'custom',
            fn: function(t){ // return only the indices of the images that were estimated to be shown at least once
                var indices = [];
                for (let i=0; i<images.length; i++) {
                    if (jsPsych.data.get().last(2).values()[0].estimate_individuals[i] == '1')
                        indices.push(i);
                }
                console.log(indices);
                return indices;
            }
        }
    }

    const word_rating_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Nun bewerten Sie die Eigenschaftsworte, die den Quadraten zugeordnet wurden. 
                <br><br>
                Geben Sie bitte an, wie <b>positiv oder negativ</b> Sie Ihre emotionale Reaktionen auf das entsprechende Eigenschaftswort sind.. 
                <br><br>
                Dabei gibt es wie zuvor keine richtigen oder falschen Antworten. Es kommt uns nur auf Ihre persönliche Einschätzung an. 
                <br><br>
                Geben Sie bitte außerdem an, wie <b>sicher</b> Sie sich bei Ihren einzelnen Einschätzungen sind. Geben Sie an, wie lange Sie bei der Entscheidung nachdenken mussten bzw. wie viel Zeit Sie dafür gebraucht haben.

            </p>
        `,
        choices: ['Weiter'],
    }

    const word_rating = {
        timeline: [
            {
                type: jsPsychHtmlSliderResponse,
                stimulus: function () {
                    used_words[0] = jsPsych.randomization.shuffle(used_words[0]);
                    used_words[1] = jsPsych.randomization.shuffle(used_words[1]);

                    console.log(used_words[0]);

                    if (used_words[0].length == 0) {
                        word = used_words[1].pop();
                    } else if (used_words[1].length == 0) {
                        word = used_words[0].pop();
                    } else {
                        word = used_words[Math.floor(Math.random() * 2)].pop();
                    }

                    console.log(word);

                    let html = `
                        <p>
                            Wie positiv oder negativ ist Ihr Eindruck dieses Eigenschaftsworts?<br><br>
                            ${word}
                        </p>
                    `
                    return html;
                },
                require_movement: true,
                labels: ['sehr negativ', 'neutral', 'sehr positiv'],
            },
            {
                type: jsPsychSurveyLikert,
                preamble: function () {
                    let html = `
                        <p>
                            Wie sicher sind Sie sich bei Ihrer Einschätzung dieses Eigenschaftsworts?<br><br>
                            ${word}
                        </p>
                    `
                    return html;
                },
                questions: [
                    {
                        prompt: "",
                        labels: [
                            "0<br>gar nicht sicher",
                            "1",
                            "2",
                            "3",
                            "4",
                            "5",
                            "6",
                            "7",
                            "8",
                            "9",
                            "10<br>extrem sicher",
                        ],
                        required: true,
                    }
                ]
            }
        ],
        button_label: 'Weiter',
        on_finish: function(data) {
            data.word = word;
        },
    }

    // Define the word_rating procedure
    const word_ratings = {
        timeline: []
    };

    for (let i=0; i<trials; i++) {
        word_ratings.timeline.push(word_rating);
    }

    const regular_ec_extinction_introduction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Bei der nächsten Aufgabe haben Sie die Möglichkeit, <b>noch einmal nacheinander mehr über diese Quadrate zu erfahren.</b>
                <br><br>
                Pro Durchgang sehen Sie alle 6 Quadrate in einer Übersicht. Der Computer wird wiederholt und nach dem Zufallsprinzip entscheiden, zu welchem Quadrat Sie mehr erfahren. Das ausgewählte Quadrat wird dann gleichzeitig mit einem <b>positiven</b> oder <b>negativen</b> Eigenschaftswort gezeigt.
                <br><br> 
                Nach jedem Durchgang kehren Sie zur Übersicht aller 6 Quadrate zurück. Insgesamt werden <b>${trials} zufällige Durchgänge</b> gezeigt, in denen Sie etwas über die Eigenschaften der Quadrate erfahren.
                <b>Bitte beobachten Sie diese Durchgänge aufmerksam.</b>
            </p>
        `,
        choices: ['Weiter'],
    }

    const extinction_ec = {
        timeline: [
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function () {
                    const html = `
                        Der Computer entscheidet nach dem Zufallsprinzip über den nächsten Durchgang!
                        <br><br>
                        Verbleibende Durchgänge ${count}
                    `
                    return html;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: `+`,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: '',
                choices: "NO_KEYS",
                trial_duration: 2000,
                on_start: function (trial) {
                    let html = ``;
                    for (let i = 0; i < images.length; i++) {
                        const style = `position: absolute; left: ${positions[i].left}; top: ${positions[i].top}; transform: translateX(-50%) translateY(-50%); width: 100px; height: 100px;`;
                        html += `<img src="${images[i].image}" style="${style}" id="img-${i}" data-image="${images[i].image}"/>`;
                    }
                    trial.stimulus = html;
                },
                on_finish: function (data) {
                    rand_id = Math.floor(Math.random() * 6);
                    data.clicked_image = images[rand_id].image;
                    data.association = images[rand_id].association;
                    data.count = count;
                },
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#img-0','#img-1','#img-2','#img-3','#img-4','#img-5']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                on_start: function (trial) {
                    const style_image = `position: absolute; left: ${left_right[jsPsych.data.get().last(2).values()[0].association]}; top: 50%; transform: translateX(-50%) translateY(-40%); width: 100px; height: 100px;`;
                    let html = `<img style="${style_image}" id="square" src="${jsPsych.data.get().last(2).values()[0].clicked_image}" />`;
                    
                    count --;
                    if (count == 0)
                        count = trials;
                    trial.stimulus = html;
                },
                choices: "NO_KEYS",
                trial_duration: 2000,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#square']}
                    }
                ],
            },
            {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: ``,
                choices: "NO_KEYS",
                trial_duration: 500,
                extensions: [
                    {
                        type: jsPsychExtensionWebgazer, 
                        params: {targets: ['#jspsych-html-keyboard-response-stimulus']}
                    }
                ],
            },
        ]
    }

    // Define the regular_ec procedure
    const regular_plus_extinction_ecs = {
        timeline: []
    };

    for (let i=0; i<trials/2; i++) {
        regular_plus_extinction_ecs.timeline.push(regular_ec);
    }

    regular_plus_extinction_ecs.timeline.push(eyeTrackingInstruction2,calibration)

    for (let i=0; i<trials/2; i++) {
        regular_plus_extinction_ecs.timeline.push(extinction_ec);
    }

    const evaluation3_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Bitte beurteilen Sie die farbigen Quadrate noch einmal. 
                <br><br>
                Sie werden nun alle 6 Quadrate einzeln sehen. Geben Sie bitte an, wie <b>positiv oder negativ</b> Ihre emotionalen Reaktionen auf das jeweilige Quadrat ist. 
                Dabei gibt es wie zuvor keine richtigen oder falschen Antworten. Es kommt uns nur auf Ihre persönliche Einschätzung an. 
                <br><br>
                Dieses Mal geben Sie bitte außerdem an, wie <b>sicher</b> Sie sich bei Ihren einzelnen Einschätzungen sind. Geben Sie an, wie lange Sie bei der Entscheidung nachdenken mussten bzw. wie viel Zeit Sie dafür gebraucht haben.
            </p>
        `,
        choices: ['Weiter'],
    }

    const evaluation3 = {
        timeline: [
            {
                type: jsPsychHtmlSliderResponse,
                stimulus: function () {
                    const html = `
                        <p>
                            Wie positiv oder negativ ist Ihr Eindruck des Quadrats in dieser Farbe?
                        </p>
                        <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;">
                    `
                    return html;
                },
                require_movement: true,
                labels: ['sehr negativ', 'neutral', 'sehr positiv'],
            },
            {
                type: jsPsychSurveyLikert,
                preamble: function () {
                    const html = `
                        <p>
                            Wie sicher sind Sie sich bei Ihrer Einschätzung dieses Quadrats?
                        <p>
                        <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;">
                    `
                    return html;
                },
                questions: [
                    {
                        prompt: "",
                        labels: [
                            "0<br>gar nicht sicher",
                            "1",
                            "2",
                            "3",
                            "4",
                            "5",
                            "6",
                            "7",
                            "8",
                            "9",
                            "10<br>extrem sicher",
                        ],
                        required: true,
                    }
                ]
            },
        ],
        timeline_variables: [
            { image: images[0].image },
            { image: images[1].image },
            { image: images[2].image },
            { image: images[3].image },
            { image: images[4].image },
            { image: images[5].image },
        ],
        button_label: 'Weiter',
    }

    const estimate2 = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: `
            <p>
                Während der Durchgänge sind die Quadrate gleichzeitig mit positiven oder negativen Eigenschaftsworte gezeigt worden. <br><br>Ihrer Schätzung nach, wie viele der ${trials/2} Eigenschaftsworte war positiv bzw. negativ?
                <br><br>
                Anzahl der positiven Eigenschaftsworte: <input id="estimate_positive" name="estimate_positive" type="number" min="0" max="${trials/2}" style="width:100px;" oninput="checkEstimates2()" required /><br>
                Anzahl der negativen Eigenschaftsworte: <input id="estimate_negative" name="estimate_negative" type="number" min="0" max="${trials/2}" style="width:100px;" oninput="checkEstimates2()" required />
                <br><br>
                ACHTUNG! Die Summer beider Zahlen muss ${trials/2} ergeben!
            </p>
            <button id="next" class="jspsych-btn" onclick="jsPsych.finishTrial()" disabled>Weiter</button>
        `,
    };

    const estimate_individuals2 = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: function () {
            let html = 'Schätzen Sie: Wie oft haben Sie die jeweiligen Quadrate gesehen?<br><br>';
            for (let i=0; i<images.length; i++) {
                html += `
                    <img src="${images[i].image}" style="width:50px; transform: translateY(+25%); margin-right: 50px;" />
                    <input name="estimate_${i}" type="number" min="0" max="${trials}" style="width:100px;" oninput="checkEstimateIndividuals2()" required /> Durchgänge (0 bis ${trials})<br>
                `
            }
            html += `
                <p>ACHTUNG! Die Summer aller Zahlen muss ${trials} ergeben!</p>
                <button id="next" class="jspsych-btn" onclick="jsPsych.finishTrial()" disabled>Weiter</button>
            `
            return html;
        },
        on_finish: function(data) {
            data.estimate_individuals2 = window.estimate_individuals2;
        }
    };

    // Function to handle button click
    function checkEstimates2() {
        estimates = document.querySelectorAll("input[type=number]");
        
        var est = 0;

        let estimate_individuals2 = "";

        for (let i=0; i<estimates.length; i++) {
            est += parseInt(estimates[i].value);
            if (parseInt(estimates[i].value) > 0)
                estimate_individuals2 += 1;
            else
                estimate_individuals2 += 0;
        }

        window.estimate_individuals2 = estimate_individuals2;

        console.log(estimate_individuals2);

        if(est==trials/2) {
            document.getElementById("next").disabled = false;
        } else {
            document.getElementById("next").disabled = true;
        }
    }

    // Function to handle button click
    function checkEstimateIndividuals2() {
        estimates = document.querySelectorAll("input[type=number]");
        
        var est = 0;

        let estimate_individuals2 = "";

        for (let i=0; i<estimates.length; i++) {
            est += parseInt(estimates[i].value);
            if (parseInt(estimates[i].value) > 0)
                estimate_individuals2 += 1;
            else
                estimate_individuals2 += 0;
        }

        window.estimate_individuals2 = estimate_individuals2;

        console.log(estimate_individuals2);

        if(est==trials) {
            document.getElementById("next").disabled = false;
        } else {
            document.getElementById("next").disabled = true;
        }
    }

    const joint_occurence2_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Nachfolgend sehen Sie alle Quadrate, für die Sie mindestens einen Durchgang angegeben haben. 
                <br><br>
                Geben Sie für jedes Quadrat an, ob es Ihrer Meinung nach öfter zusammen mit positiven oder negativen Eigenschaftsworten auftrat.
            </p>
        `,
        choices: ['Weiter'],
    }

    var joint_occurence2 = {
        type: jsPsychSurveyMultiChoice,
        timeline: [
            {
                preamble: function () {
                    let html = `
                        <p style="text-align: center;">
                            <img src="${jsPsych.evaluateTimelineVariable('image')}" style="width: 200px; height: 200px;"><br>
                            Trat dieses Quadrat öfter gemeinsam mit positiven oder mit negativen Eigenschaftsworten auf?
                        </p>
                    `
                    return html;
                }, 
                questions: [
                    {
                        prompt: "", 
                        options: [
                            'Mit <b>positiven</b> Eigenschaftsworten', 
                            'Mit <b>negativen</b> Eigenschaftsworten'
                        ], 
                        required: true
                    }
                ],
            },
        ],
        timeline_variables: [
            { image: images[0].image },
            { image: images[1].image },
            { image: images[2].image },
            { image: images[3].image },
            { image: images[4].image },
            { image: images[5].image },
        ],
        button_label: 'Weiter',
        sample: {
            type: 'custom',
            fn: function(t){ // return only the indices of the images that were estimated to be shown at least once
                var indices2 = [];
                for (let i=0; i<images.length; i++) {
                    if (jsPsych.data.get().last(2).values()[0].estimate_individuals2[i] == '1')
                        indices2.push(i);
                }
                console.log(indices2);
                return indices2;
            }
        }
    }

    const word_rating2_intro = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <p>
                Nun bewerten Sie die Eigenschaftsworte, die den Quadraten zugeordnet wurden. 
                <br><br>
                Geben Sie bitte an, wie <b>positiv oder negativ</b> Sie Ihre emotionale Reaktionen auf das entsprechende Eigenschaftswort sind.. 
                <br><br>
                Dabei gibt es wie zuvor keine richtigen oder falschen Antworten. Es kommt uns nur auf Ihre persönliche Einschätzung an. 
                <br><br>
                Geben Sie bitte außerdem an, wie <b>sicher</b> Sie sich bei Ihren einzelnen Einschätzungen sind. Geben Sie an, wie lange Sie bei der Entscheidung nachdenken mussten bzw. wie viel Zeit Sie dafür gebraucht haben.

            </p>
        `,
        choices: ['Weiter'],
    }

    const word_rating2 = {
        timeline: [
            {
                type: jsPsychHtmlSliderResponse,
                stimulus: function () {
                    used_words[0] = jsPsych.randomization.shuffle(used_words[0]);
                    used_words[1] = jsPsych.randomization.shuffle(used_words[1]);

                    console.log(used_words[0]);

                    if (used_words[0].length == 0) {
                        word = used_words[1].pop();
                    } else if (used_words[1].length == 0) {
                        word = used_words[0].pop();
                    } else {
                        word = used_words[Math.floor(Math.random() * 2)].pop();
                    }

                    console.log(word);

                    let html = `
                        <p>
                            Wie positiv oder negativ ist Ihr Eindruck dieses Eigenschaftsworts?<br><br>
                            ${word}
                        </p>
                    `
                    return html;
                },
                require_movement: true,
                labels: ['sehr negativ', 'neutral', 'sehr positiv'],
            },
            {
                type: jsPsychSurveyLikert,
                preamble: function () {
                    let html = `
                        <p>
                            Wie sicher sind Sie sich bei Ihrer Einschätzung dieses Eigenschaftsworts?<br><br>
                            ${word}
                        </p>
                    `
                    return html;
                },
                questions: [
                    {
                        prompt: "",
                        labels: [
                            "0<br>gar nicht sicher",
                            "1",
                            "2",
                            "3",
                            "4",
                            "5",
                            "6",
                            "7",
                            "8",
                            "9",
                            "10<br>extrem sicher",
                        ],
                        required: true,
                    }
                ]
            }
        ],
        button_label: 'Weiter',
        on_finish: function(data) {
            data.word = word;
        },
    }

    // Define the word_rating procedure
    const word_ratings2 = {
        timeline: []
    };

    for (let i=0; i<trials/2; i++) {
        word_ratings2.timeline.push(word_rating2);
    }

    const demographics = {
        type: jsPsychSurveyHtmlForm,
        preamble: '<p>Abschließend bitten wir Sie noch um einige Angaben zu Ihrer Person:</b></p>',
        html: `
            <p> 
                Alter in Jahren: <input name="age" type="number" required /><br>
                Geschlecht: <input name="gender" type="text" required />
            </p>
        `,
        button_label: ['Weiter'],
    }

    const end = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: `
            <p>
                Danke für Ihre Teilnahme an der Studie! Sie können das Fenster jetzt schließen.
            </p>
        `,
    }


    //  // link to the backend
    var show_data = {
        type: jsPsychHtmlKeyboardResponse,
        on_start: () =>  jsPsych.data.get().localSave('json','mydata.json'),
        stimulus: function() {
            var trial_data = jsPsych.data.get().values();
            var trial_json = JSON.stringify(trial_data, null, 2);
            return `
                <p style="margin-bottom:0px;"><strong>Trial data:</strong></p>
                <pre style="margin-top:0px;text-align:left;">${trial_json}</pre>
            `;
        },
        choices: "NO_KEYS",
    
    };

    time_line = [];

    time_line.push(welcome);
    time_line.push(evaluation1_intro);
    time_line.push(evaluation1);
    if(treatment == "free_sampling") {
        time_line.push(free_sampling_transition);
        time_line.push(fullscreenEnter, eyeTrackingInstruction1, eyeTrackingNote, calibrationInstruction,init_camera,calibration,validationInstruction, validation,recalibrate)
        time_line.push(free_sampling_introduction);
        time_line.push(free_samplings);
    } else {
        time_line.push(regular_ec_transition);
        time_line.push(fullscreenEnter, eyeTrackingInstruction1, eyeTrackingNote, calibrationInstruction,init_camera,calibration,validationInstruction, validation,recalibrate)
        time_line.push(regular_ec_introduction);
        time_line.push(regular_ecs);
    }
    time_line.push(evaluation2_intro);
    time_line.push(evaluation2);
    time_line.push(estimate);
    time_line.push(estimate_individuals);
    time_line.push(joint_occurence_intro);
    time_line.push(joint_occurence);
    time_line.push(word_rating_intro);
    time_line.push(word_ratings);
    time_line.push(eyeTrackingNote,calibration,validationInstruction,validation,recalibrate)
    time_line.push(regular_ec_extinction_introduction);
    time_line.push(regular_plus_extinction_ecs);
    time_line.push(evaluation3_intro);
    time_line.push(evaluation3);
    time_line.push(estimate2);
    time_line.push(estimate_individuals2);
    time_line.push(joint_occurence2_intro);
    time_line.push(joint_occurence2);
    time_line.push(word_rating2_intro);
    time_line.push(word_ratings2);
    time_line.push(demographics);
    time_line.push(fullscreenEnd,show_data);
    time_line.push(end);

    jsPsych.run([time_line]);

</script>

</html>